<!DOCTYPE html>
<html>
<head>
    <%- include('partials/head'); %>
    <title>Quiz</title>
    <link rel="stylesheet" href="/css/quiz.css">
</head>
<body>
    <div id="answer" style="visibility: hidden;">
        <div id="character" class="jptext">

        </div>
        <div id="diagram">
            <svg id="kanjiAnim" class="kanjiVG" width="109" height="109">
                <!-- SVGs will get loaded by script.js here  -->
            </svg>
        </div>
    </div>

    <div id="meaning">

    </div>

    <div id="meaningAlt">

    </div>

    <div id="readings">On'yomi: <span id="onyomi"></span>&emsp;Kun'yomi: <span id="kunyomi"></span></div>

    <div id="buttons">
        <button id="showAnswer">Show Answer</button>
        <button id="markCorrect" style="display: none;">Correct</button>
        <button id="markIncorrect" style="display: none;">Incorrect</button>
    </div>
    
    <% if (quizSubjects != null) { %>
    <script src="/js/KanjivgAnimate.min.js"></script>
    <script src="/js/kanjianim.js"></script>
    <script>
        var quizSubjects = <%-quizSubjects%>;

        //quizSubjects = quizSubjects.replace(/'/ig, "\'");

        //console.log(quizSubjects);

        //console.log(JSON.parse(quizSubjects));
        
        var characterElement = document.getElementById("character");
        var meaningElement = document.getElementById("meaning");
        var meaningAltElement = document.getElementById("meaningAlt");
        var answerElement = document.getElementById("answer");
        var onyomiElement = document.getElementById("onyomi");
        var kunyomiElement = document.getElementById("kunyomi");
        var diagramElement = document.getElementById("diagram");
        var showAnsBTN = document.getElementById("showAnswer");
        var correctBTN = document.getElementById("markCorrect");
        var incorrectBTN = document.getElementById("markIncorrect");
        var diagramElement = document.getElementById("diagram");
        var kanjiAnimElement = document.getElementById("kanjiAnim");
        showAnsBTN.addEventListener("click", showAnswer);
        correctBTN.addEventListener("click", markCorrect);
        incorrectBTN.addEventListener("click", markIncorrect);

        init();

        function init() {
            subjectQueue = quizSubjects.data;
            setSubject(subjectQueue[0]);
        }

        function showAnswer() {
            correctBTN.style.display = 'inline-block';
            incorrectBTN.style.display = 'inline-block';
            showAnsBTN.style.display = 'none';
            answerElement.style.visibility = 'visible';
        }

        function markCorrect() {
            // Takes the subject out of the queue
            subjectQueue.shift();
            console.log("ping");
            nextSubject();
        }

        function markIncorrect() {
            // Takes the subject out of the queue and puts it in the back of the queue
            subjectQueue.push(subjectQueue.shift());
            nextSubject();
        }

        function nextSubject() {
            // If there are more subjects left
            if (subjectQueue.length > 0) {
                // Maybe do shift() here to be safer
                setSubject(subjectQueue[0]);
                correctBTN.style.display = 'none';
                incorrectBTN.style.display = 'none';
                showAnsBTN.style.display = 'inline-block';
                answerElement.style.visibility = 'hidden';
            } else {
                window.location.href = "/";
            }
        }

        function setSubject(subject) {
            characterElement.innerHTML = subject.data.characters;
            meaningElement.innerHTML = getPrimaryMeaning(subject.data.meanings);
            meaningAltElement.innerHTML = getSecondaryMeanings(subject.data.meanings);
            onyomiElement.innerHTML = getOnyomiString(subject.data.readings);
            kunyomiElement.innerHTML = getKunyomiString(subject.data.readings);
            kanjiAnimElement.id = subject.data.characters;
            load();
        }

        function getOnyomiString(readings) {
            let onyomiArray = [];
            for (const reading of readings) {
                if (reading.type == "onyomi") onyomiArray.push(reading.reading);
            }

            return onyomiArray.join(", ");
        }

        function getKunyomiString(readings) {
            let kunyomiArray = [];
            for (const reading of readings) {
                if (reading.type == "kunyomi") kunyomiArray.push(reading.reading);
            }

            return kunyomiArray.join(", ");
        }

        function getPrimaryMeaning(meanings) {
            for (const meaning of meanings) {
                if (meaning.primary) return meaning.meaning;
            }

            return null;
        }

        function getSecondaryMeanings(meanings) {
            let meaningArray = [];
            for (const meaning of meanings) {
                if (!meaning.primary) meaningArray.push(meaning.meaning);
            }

            return meaningArray.join(", ");
        }
     </script>
     <% } %>
</body>
</html>